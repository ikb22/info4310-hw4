<html>
  <head>
    <title>Visualizing European Drug Development</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .flex {
        display: flex;
        flex-direction: row;
      }
      .center {
        text-align: center;
      }
      #drug_details {
        border: 1px solid black;
        width: 40%;
        margin: 10px;
        padding: 5px;
      }
      #barchart {
        border: 1px solid black;
      }
      #timeline {
        margin: 10px;
      }

      body {
        font-family: "Roboto Slab", sans-serif;
      }

      .legend {
        font-family: "Roboto Slab", sans-serif;
      }

      .axis {
        font-family: "Roboto Slab", sans-serif;
      }

      .bar:hover {
        stroke: black;
      }

      .box:hover {
        stroke: black;
      }

      rect.bar:hover {
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="center">
      <h1>Visualizing European Drug Development in the Past 20 Years</h1>
      <svg id="barGraph" height="600" width="1000"></svg>
      <h3>Specific category goes here:</h3>
    </div>
    <div class="flex">
      <svg id="timeline" height="100" width="800"></svg>
      <div id="drug_details">
        <p style="text-align: center; text-decoration: underline">
          Drug Details:
        </p>
      </div>
    </div>
    <script>
      // bar chart setup
      let barGraph = d3.select("svg#barGraph");
      const barTotalWidth = barGraph.attr("width");
      const barTotalHeight = barGraph.attr("height");
      const barGraphMargin = {
        top: 10,
        right: 200,
        bottom: 180,
        left: 70,
      };
      const barGraphWidth =
        barTotalWidth - barGraphMargin.left - barGraphMargin.right;
      const barGraphHeight =
        barTotalHeight - barGraphMargin.top - barGraphMargin.bottom - 10;
      let barGraphAnnotations = barGraph.append("g").attr("id", "annotations");

      let areas = [
        "Diabetes Mellitus, Type 2",
        "HIV Infections",
        "Hypertension",
        "Diabetes Mellitus",
        "Pulmonary Disease, Chronic Obstructive",
        "Multiple Myeloma",
        "Hepatitis C, Chronic",
        "Parkinson Disease",
        "Carcinoma, Non-Small-Cell Lung",
        "Epilepsy",
      ];

      const createGraph = async function () {
        let histo = d3.select("#histo");
        let drug_data = await d3.csv("drugs_clean.csv");
        console.log(drug_data);

        hist_approved = {};
        hist_withdrawn = {};

        areas.forEach((a) => {
          hist_approved[a] = 0;
          hist_withdrawn[a] = 0;
        });

        drug_data.forEach((d) => {
          let approved = d.authorisation_status;
          if (approved == "authorised") {
            hist_approved[d.therapeutic_area] += 1;
          } else {
            hist_withdrawn[d.therapeutic_area] += 1;
          }
        });

        console.log("hist:", hist_approved, hist_withdrawn);

        // Y scale (Count)
        let countScale = d3
          .scaleLinear()
          .domain([0, 100])
          .range([barGraphHeight, 0]);

        console.log("test count", countScale("80"));

        // X Scale (Category)
        let areaScale = d3.scaleBand().domain(areas).range([0, barGraphWidth]);

        let bottomAxis = d3.axisBottom(areaScale);
        barGraphAnnotations
          .append("g")
          .attr("class", "x axis")
          .attr(
            "transform",
            `translate(${barGraphMargin.left}, ${
              barGraphHeight + barGraphMargin.top + 10
            })`
          )
          .call(bottomAxis)
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("transform", "translate(-10, 2) rotate(-45)");

        let leftAxis = d3.axisLeft(countScale);
        barGraphAnnotations
          .append("g")
          .attr("class", "y axis")
          .attr(
            "transform",
            `translate(${barGraphMargin.left - 10}, ${barGraphMargin.top})`
          )
          .call(leftAxis);

        barGraphAnnotations
          .append("text")
          .attr("class", "x label")
          .attr("text-anchor", "middle")
          .attr("x", barGraphWidth / 2 + barGraphMargin.left)
          .attr(
            "y",
            barGraphHeight + barGraphMargin.top + barGraphMargin.bottom
          )
          .text("Thereupetic Area");

        barGraphAnnotations
          .append("text")
          .attr("class", "y label")
          .attr("text-anchor", "middle")
          .attr("y", 5)
          .attr("x", -barGraphHeight / 2 + barGraphMargin.top)
          .attr("dy", ".6em")
          .attr("transform", "rotate(-90)")
          .text("Count");

        // make some filters

        // boxes
        let a_box = barGraphAnnotations
          .append("rect")
          .attr("id", "a")
          .attr("class", "box")
          .attr("y", barGraphMargin.top)
          .attr("x", 800)
          .attr("height", 20)
          .attr("width", 20)
          .style("fill", "#90EF90");

        let w_box = barGraphAnnotations
          .append("rect")
          .attr("id", "w")
          .attr("class", "box")
          .attr("y", barGraphMargin.top + 40)
          .attr("x", 800)
          .attr("height", 20)
          .attr("width", 20)
          .style("fill", "#FC6C85");

        d3.selectAll(".box")
          .on("mouseover", function (d) {
            let type = d.target.id;
            hideBars(type);
          })
          .on("mouseout", function () {
            showAllBars();
          });

        // texts
        barGraphAnnotations
          .append("text")
          .attr("class", "alegend legend")
          .attr("text-anchor", "middle")
          .attr("y", barGraphMargin.top + 7)
          .attr("x", 860)
          .attr("dy", ".5em")
          .style("stroke", "black")
          .style("font-weight", 400)
          .text("Approved");

        barGraphAnnotations
          .append("text")
          .attr("class", "wlegend legend")
          .attr("text-anchor", "middle")
          .attr("y", barGraphMargin.top + 47)
          .attr("x", 865)
          .attr("dy", ".5em")
          .style("font-weight", 400)
          .style("stroke", "black")
          .text("Withdrawn");

        let rectWidth = barGraphWidth / 20 - 10;

        let barCount = 0;

        // make some bars
        for (key in hist_approved) {
          barCount += 1;
          let a_count = hist_approved[key];
          let w_count = hist_withdrawn[key];

          barGraph
            .append("rect")
            .attr("x", areaScale(key) + barGraphMargin.left + 10)
            .attr("y", countScale(a_count) + barGraphMargin.top)
            .attr("width", rectWidth)
            .attr("height", barGraphHeight - countScale(a_count))
            .style("fill", "#90EF90")
            .attr("class", `a ${key} bar`)
            .attr("area", barCount)
            .attr("therapeutic_area", key + "-" + "a")
            .on("mouseover", function (d) {
              let area = d3.select(this).attr("area");
              console.log(area);
              d3.select(`[id="${area}"]`).style("opacity", 1);
            })
            .on("mouseout", function () {
              let area = d3.select(this).attr("area");
              console.log(area);
              d3.select(`[id="${area}"]`).style("opacity", 0);
            })
            .on("click", function (d) {
              let area = d3.select(this).attr("therapeutic_area");
              barSelected(area);
            });

          barGraphAnnotations
            .append("text")
            .attr("class", "acount")
            .attr("id", barCount)
            .attr("text-anchor", "middle")
            .attr("y", countScale(a_count) - 10)
            .attr("x", areaScale(key) + barGraphMargin.left + 24)
            .attr("dy", ".5em")
            .style("stroke", "green")
            .style("opacity", 0.0)
            .text(a_count);

          barCount += 1;

          barGraphAnnotations
            .append("text")
            .attr("class", "wcount")
            .attr("id", barCount)
            .attr("text-anchor", "middle")
            .attr("y", countScale(w_count) - 10)
            .attr("x", areaScale(key) + barGraphMargin.left + 50)
            .attr("dy", ".5em")
            .style("stroke", "red")
            .style("opacity", 0.0)
            .text(w_count);

          barGraph
            .append("rect")
            .attr("x", areaScale(key) + barGraphMargin.left + 36.5)
            .attr("y", countScale(w_count) + barGraphMargin.top)
            .attr("width", rectWidth)
            .attr("height", barGraphHeight - countScale(w_count))
            .attr("area", barCount)
            .style("fill", "#FC6C85")
            .attr("class", `w ${key} bar`)
            .attr("therapeutic_area", key + "-" + "w")
            .on("mouseover", function (d) {
              let area = d3.select(this).attr("area");
              console.log(area);
              d3.select(`[id="${area}"]`).style("opacity", 1);
            })
            .on("mouseout", function () {
              let area = d3.select(this).attr("area");
              console.log(area);
              d3.select(`[id="${area}"]`).style("opacity", 0);
            })
            .on("click", function (d) {
              let area = d3.select(this).attr("therapeutic_area");
              barSelected(area);
            });
        }

        function hideBars(type) {
          let all = d3.selectAll(".bar").style("opacity", "0");
          let selected = d3
            .selectAll(`.${type}`)
            .transition()
            .style("opacity", "1");
          let color = type == "a" ? "green" : "red";
          let selectedText = d3
            .selectAll(`.${type}legend`)
            .transition()
            .style("stroke", color);
        }

        function highlightBar(bar) {
          bar.style("stroke", "black");
        }

        function showAllBars() {
          d3.selectAll(`.bar`).transition().style("opacity", "1");
          let selectedText = d3
            .selectAll(`.legend`)
            .transition()
            .style("stroke", "black");
        }

        // function that gives the thereapeutic area and whether or not it's approved or withdrawn
        function barSelected(area) {
          console.log("click: ", area);
        }

        // ISABELLE CODE
        // isabelle --> timeline graph + specific drug information in tabular view

        let timeline = d3.select("#timeline");
        let timeline_width = timeline.attr("width");
        let timeline_height = timeline.attr("height");
        let timeline_margins = { top: 0, right: 5, bottom: 20, left: 5 };
        let graphWidth =
          timeline_width - timeline_margins.left - timeline_margins.right;
        let graphHeight =
          timeline_height - timeline_margins.top - timeline_margins.bottom;
        let timelineAnnotations = timeline
          .append("g")
          .attr("id", "annotations");
        let timelineArea = timeline.append("g").attr("id", "timelinearea");

        // how to time parse the time format we are given???
        const timeParser = d3.timeParse("%Y-%m-%dT%H:%M:%SZ");
        let time_extent = d3.extent(drug_data, (d) =>
          timeParser(d["first_published"])
        );
        console.log("time extent", time_extent);
        const timeScale = d3
          .scaleTime()
          .domain(time_extent)
          .range([0, graphWidth]);

        let timeline_bottomAxis = d3.axisBottom(timeScale);
        timelineAnnotations
          .append("g")
          .attr("class", "x axis")
          .attr(
            "transform",
            `translate(${timeline_margins.left},${graphHeight})`
          )
          .call(timeline_bottomAxis);
      };
      createGraph();
    </script>
  </body>
</html>
